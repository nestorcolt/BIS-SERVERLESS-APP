AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: SAM Template for BIS-Cloud

Parameters:
    PackagesLayerArn:
        Type: String
        Default: arn:aws:lambda:us-east-1:436783151981:layer:PythonPackagesLayer:1 # Change account it also here

    AccountId:
        Type: String
        Default: 436783151981

Resources:
    # dynamo db  ----------------------------------------------------------------------------------------
    DynamoDBTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: Users
            StreamSpecification:
                StreamViewType: NEW_AND_OLD_IMAGES
            AttributeDefinitions:
                -   AttributeName: user_id
                    AttributeType: S
            KeySchema:
                -   AttributeName: user_id
                    KeyType: HASH
            ProvisionedThroughput:
                ReadCapacityUnits: 1
                WriteCapacityUnits: 1

    BlocksTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: Blocks
            StreamSpecification:
                StreamViewType: NEW_AND_OLD_IMAGES
            AttributeDefinitions:
                -   AttributeName: user_id
                    AttributeType: S
                -   AttributeName: block_id
                    AttributeType: N
                -   AttributeName: station_id
                    AttributeType: S
            KeySchema:
                -   AttributeName: user_id
                    KeyType: HASH
                -   AttributeName: block_id
                    KeyType: RANGE
            ProvisionedThroughput:
                ReadCapacityUnits: 1
                WriteCapacityUnits: 1

            GlobalSecondaryIndexes:
                -   IndexName: Blocks_GSI1
                    KeySchema:
                        -   AttributeName: station_id
                            KeyType: HASH
                    Projection:
                        ProjectionType: ALL
                    ProvisionedThroughput:
                        ReadCapacityUnits: 1
                        WriteCapacityUnits: 1

    # Lambda layers ----------------------------------------------------------------------------------------
    CustomAppLayers:
        Type: AWS::Serverless::LayerVersion
        Properties:
            LayerName: CustomAppLayers
            Description: Owner modules
            ContentUri: ../../CloudCore/python
            RetentionPolicy: Retain
            LicenseInfo: MIT
            CompatibleRuntimes:
                - python3.6
        Metadata:
            BuildMethod: python3.6

    # Lambdas section ---------------------------------------------------------------------------------------
    SleepSearchEngineInstance:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 1024
            Timeout: 20
            FunctionName: SleepSearchEngineInstance
            Description: Handles the put to sleep of a search engine Ec2 instance for 30 minutes
            CodeUri: serverless/searchEngine/
            Handler: sleep.function_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonSNSFullAccess
                - AmazonEC2FullAccess
                - AmazonDynamoDBFullAccess
                - AWSLambdaDynamoDBExecutionRole
            Events:
                SNSEvent:
                    Type: SNS
                    Properties:
                        Topic: !Sub 'arn:aws:sns:us-east-1:${AccountId}:SE-SLEEP-INSTANCE-SERVICE'

    SearchEngineCloudLogs:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 256
            Timeout: 5
            FunctionName: SearchEngineCloudLogs
            Description:
            CodeUri: serverless/logging/
            Handler: engineLogger.lambda_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonSNSFullAccess
                - CloudWatchLogsFullAccess
            Events:
                SNSEvent:
                    Type: SNS
                    Properties:
                        Topic: !Sub 'arn:aws:sns:us-east-1:${AccountId}:SE-LOGS-SERVICE'

    CronoLambda1Minute:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 2048
            Timeout: 60
            FunctionName: CronoLambda1Minute
            Description: Check dynamo db every minute to wake up every asleep ec2 instance
            CodeUri: serverless/cronoLambdas/
            Handler: sleepStatusCheck.sleep_status_check_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonDynamoDBFullAccess
                - AmazonSNSFullAccess
                - AmazonEC2FullAccess
            Events:
                StartScheduledEvent:
                    Type: Schedule
                    Properties:
                        Schedule: cron(0/1 * * * ? *)

    CleanBlocksTable:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 2048
            Timeout: 360
            FunctionName: CleanBlocksTable
            Description: Check dynamo db every day at mid night to delete blocks captured 48 hours ago
            CodeUri: serverless/cronoLambdas/
            Handler: cleanBlocksTable.lambda_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonDynamoDBFullAccess
            Events:
                StartScheduledEvent:
                    Type: Schedule
                    Properties:
                        Schedule: cron(59 23 * * ? *)

    UpdateBlocksTable:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 1024
            Timeout: 20
            FunctionName: UpdateBlocksTable
            Description: Handles the update of blocks table with the blocks info
            CodeUri: serverless/capturedBlocks/
            Handler: updateBlocksTable.function_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonSNSFullAccess
                - AmazonDynamoDBFullAccess
            Events:
                SNSEvent:
                    Type: SNS
                    Properties:
                        Topic: !Sub 'arn:aws:sns:us-east-1:${AccountId}:SE-ACCEPTED-BLOCK-SERVICE'

    NotifyBlockToWeb:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 1024
            Timeout: 20
            FunctionName: NotifyBlockToWeb
            Description: Send a post request to a web endpoint with the block info
            CodeUri: serverless/apiGateway/
            Handler: notifyWeb.lambda_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonSNSFullAccess
                - AmazonDynamoDBFullAccess
            Events:
                SNSEvent:
                    Type: SNS
                    Properties:
                        Topic: !Sub 'arn:aws:sns:us-east-1:${AccountId}:SE-ACCEPTED-BLOCK-SERVICE'

    # api gateway lambdas ----------------------------------------------------------------------------------------
    ApiCreateUser:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 1024
            Timeout: 20
            FunctionName: ApiCreateUser
            Description: Handles creation of a user in dynamo db Users table
            CodeUri: serverless/apiGateway/
            Handler: createUser.function_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonDynamoDBFullAccess
                - AmazonAPIGatewayInvokeFullAccess
            Events:
                Endpoints:
                    Type: Api
                    Properties:
                        Path: /users
                        Method: post

    ApiDeleteUser:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 1024
            Timeout: 20
            FunctionName: ApiDeleteUser
            Description: Handles deletion of a user in dynamo db Users table
            CodeUri: serverless/apiGateway/
            Handler: deleteUser.function_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonDynamoDBFullAccess
                - AmazonAPIGatewayInvokeFullAccess
            Events:
                Endpoints:
                    Type: Api
                    Properties:
                        Path: /users
                        Method: delete

    ApiUpdateUser:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 1024
            Timeout: 20
            FunctionName: ApiUpdateUser
            Description: Handles update of a user in dynamo db Users table
            CodeUri: serverless/apiGateway/
            Handler: updateUser.function_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonDynamoDBFullAccess
                - AmazonAPIGatewayInvokeFullAccess
            Events:
                Endpoints:
                    Type: Api
                    Properties:
                        Path: /users
                        Method: put

    ApiReadUserBlocks:
        Type: AWS::Serverless::Function
        Properties:
            MemorySize: 1024
            Timeout: 20
            FunctionName: ApiReadUserBlocks
            Description: Handles the reading of the user's blocks on the Blocks table
            CodeUri: serverless/apiGateway/
            Handler: readUserBlocks.function_handler
            Runtime: python3.6
            Layers:
                - !Ref CustomAppLayers
                - !Ref PackagesLayerArn
            Policies:
                - AmazonDynamoDBFullAccess
                - AmazonAPIGatewayInvokeFullAccess
            Events:
                Endpoints:
                    Type: Api
                    Properties:
                        Path: /blocks
                        Method: post